{% extends "herobase/layout/base.html" %}
{% load i18n hero_actions hero_message static %}
{% block javascript %}
    <script type="text/javascript" src="{% get_static_prefix %}js/forms.js"></script>
    <script>
        $(function() {
            confirm_button("input[name=action_btn]");
        });
    </script>
    <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
{% endblock %}

{% block meta %}
    <meta property="og:type" content="website" />
    <meta property="og:title" content="You Are Hero - {{ quest.title }}" />
    <meta property="og:site_name" content="You Are Hero" />
    <meta property="og:image" content="{% get_static_prefix %}img/logo.png" />
    <meta property="og:description" content="{{ quest.description }}" />
{% endblock %}

{% block submenu %}
    {% include "herobase/quest/submenu.inc.html"%}
{% endblock %}

{% block page_title %}
    <h1>{% trans "Quests" %}</h1>
{% endblock %}

{% block content %}
    <h1>Du bisch en Held!</h1>
    <form method="POST" action="{% url hero-update-quest quest.pk %}">
        {% csrf_token %}
        <input type="submit" name="action" value="apply"/>
        <input type="submit" name="action" value="cancel"/>
    </form>

    <div class="quest-detail well quest-class-{{ quest.hero_class }}">
        <div class="page-header">
            <h2>{{ quest.title }}
                <small>
                    {{ quest.get_hero_class_display|default:_("all classes") }}
                    <div class="charicon {{ quest.get_hero_class_display }}"/>
                </small>
            </h2>
        </div>
        <div class="well">{{ quest.description|linebreaks }}</div>

        <div class="row-fluid">
            <div class="span6">
                <dl class="dl-horizontal">
                    <dt>{% trans "Author" %}</dt><dd><a href="{% url userprofile-public quest.owner.username %}">{{ quest.owner }}</a>{% message_user quest.owner %}</dd>
                    <dt>{% trans "Location" %}</dt><dd>{{ quest.location }}</dd>
                </dl>
            </div>
            <div class="span6">
                <dl class="dl-horizontal">
                    <dt>{% trans "Level" %}</dt><dd>{{ quest.level }}</dd>
                    <dt>{% trans "Experience" %}</dt><dd>{{ quest.experience }}</dd>
                </dl>
            </div>
        </div>

        {# Owner #}
        {% if request.user == quest.owner %}
            <h2>Du bist der Auftraggeber</h2>
            {% if quest.is_active %}
                {% if not quest.heroes.exists %}
                    <p>Dies ist Dein Quest. Sobald ein Held Dir helfen möchte siehst Du unten eine Liste mit Deinen Helden</p>
                {% else %}
                    {% if quest.applying_heroes.exists %}
                        <p>Hey, es gibt Helden die Dir helfen möchten! Akzeptiere einen Held und er wird Dir helfen.
                            Wenn Dir ein Held nicht geheuer ist, kannst Du ihn auch zurückweisen.</p>
                    {% endif %}
                    {% if quest.active_heroes.exists %}
                        {% if not quest.is_full %}
                            <p>Du hast schon {{ quest.active_heroes.count }} Held{{ quest.active_heroes.count|pluralize:" der dir hilft,en die Dir helfen" }}.
                                Noch {{ quest.remaining_slots }} Held{{ quest.remaining_slots|pluralize:" kann,en können" }} teilnehmen.</p>
                        {% else %}
                            <p>Dir {{ quest.max_heroes|pluralize:"hilft,helfen" }} {{ quest.max_heroes }} Held{{ quest.max_heroes|pluralize:"en" }}. Deine Quest ist voll.</p>
                        {% endif %}
                        <p>Wenn Du die Quest abschließt, kannst Du die Teilnahme Deiner Helden bestätigen und somit Erfahrungspunkte verteilen :-) </p>
                        <p><strong>Achtung:</strong> An einer abgeschlossenen Quest können keine weiteren Helden teilnehmen.</p>
                    {% endif %}
                {% endif %}
                <p>Für abgebrochene Quests bekommt niemand Erfahrungspunkte. Eine abgebrochene Quest kann nicht wieder aufgenommen werden.</p>
            {% else %}
                {% if quest.is_canceled %}
                    <p>Du hast diese Quest abgebrochen. Niemand bekommt Erfahrungspunkte :-(</p>
                {% elif quest.is_done %}
                    <p>Diese Quest is abgeschlossen. Verteile nun Erfahrungspunkte an alle Helden die Dir geholfen haben
                        indem Du die Teilnahme bestätigst.</p>
                {% endif %}
            {% endif %}
        {% elif quest.is_canceled %}
            <h2>Abgebrochen</h2>
            <p>Der Auftraggeber
                (<a href="{% url userprofile-public quest.owner.username %}">{{ quest.owner }}</a>)
                hat diese Quest leider abgebrochen.</p>
            {# Hero #}
        {% elif adventure %}
            {% if adventure.state == adventure.STATE_HERO_APPLIED %}
                <h2>Du hast Dich beworben</h2>
                <p>Du hast Dich für diese Quest beworben. Sobald der Auftraggeber
                    (<a href="{% url userprofile-public quest.owner.username %}">{{ quest.owner }}</a>)
                    Dich akzeptiert, kann es losgehen.</p>
                <p>Wenn Dir etwas dazwischengekommen ist, kannst Du die Quest auch abbrechen.</p>
            {% elif adventure.state == adventure.STATE_OWNER_REFUSED %}
                <h2>Zurückgewiesen</h2>
                <p>Schade. Der Auftraggeber
                    (<a href="{% url userprofile-public quest.owner.username %}">{{ quest.owner }}</a>)
                    hat Dich zurückgewiesen. Aber nicht verzagen, vielleicht war die Quest einfach schon voll.</p>
            {% elif adventure.state == adventure.STATE_HERO_CANCELED %}
                <h2>Abgebrochen</h2>
                <p>Du hast diese Quest abgebrochen. Wenn Du möchtest, kannst Du Dich wieder bewerben.</p>
            {% elif adventure.state == adventure.STATE_OWNER_ACCEPTED %}
                <h2>Du nimmst teil</h2>
                <p>Du nimmst an dieser Quest teil und der Auftraggeber
                    (<a href="{% url userprofile-public quest.owner.username %}">{{ quest.owner }}</a>)
                    hat dich akzeptiert.</p>
                <p>Jetzt solltest Du zur Tat schreiten!</p>
                <p>Wenn Dir etwas dazwischengekommen ist, kannst Du die Quest auch abbrechen.</p>
            {% elif adventure.state == adventure.STATE_HERO_DONE %}
                <h2>Du nimmst teil</h2>
                <p>Du nimmst an dieser Quest teil und hast dem Auftraggeber
                    (<a href="{% url userprofile-public quest.owner.username %}">{{ quest.owner }}</a>)
                    mitgeteilt, dass Du die Quest erledigt hast.</p>
                <p>Jetzt muss der Auftraggeber Deine Teilnahme nur noch bestätigen und Du bekommst Erfahrungspunkte.</p>
            {% elif adventure.state == adventure.STATE_OWNER_DONE %}
                <h2>Erfolgreich abgeschlossen</h2>
                <p>Du hast an dieser Quest teilgenommen und Deinen Heldenmut bewiesen.</p>
                <p>Du hast {{ quest.experience }} Erfahrungspunkte erhalten.</p>
            {% endif %}
        {% elif quest.is_done %}
            <h2>Abgeschlossen</h2>
            <p>Diese Quest ist schon abgeschlossen. Es ist keine Teilnahme möglich.</p>
        {% elif quest.is_full %}
            <h2>Voll</h2>
            <p>Diese Quest ist leider schon voll. Es ist keine Teilnahme möglich.</p>
        {% else %}
            <h2>Helden gesucht</h2>
            <p>Diese Herausforderung braucht noch Helden. Wenn Dir die Beschreibung zusagt, kannst Du Dich bewerben.</p>
        {% endif %}

        {# FIXME: quest actions #}
        <table>
            <tr><td><a name="fb_share"></a></td>
                <td><a href="https://twitter.com/share" class="twitter-share-button" data-size="small" data-hashtags="yah!" data-count="none">Tweet</a></td>
                <td><g:plusone size="medium" annotation="none"></g:plusone></td>
                <td><a href="http://pinterest.com/pin/create/button/?url=https%3A%2F%2Fyouarehero.net{{request.get_full_path|urlencode }}&media={{ "https://youarehero.net/static/img/logo.png"|urlencode}}&description={{ quest.description|urlencode }}" class="pin-it-button" count-layout="horizontal"><img border="0" src="//assets.pinterest.com/images/PinExt.png" title="Pin It" /></a></td>
                <td><div id="diaspora" style="width: 153px;height:30px;background:url('{% get_static_prefix %}img/icons/diaspora-share.png') no-repeat left top; background-position:0px 0px;" onClick="javascript:(function(){f='https://joindiaspora.com/bookmarklet?url='+encodeURIComponent(window.location.href)+'&title='+encodeURIComponent('Shared a link...')+'¬es='+encodeURIComponent(document.title)+'&v=1&';if(!window.open(f+'noui=1&jump=doclose','diasporav1','location=no,links=no,scrollbars=no,toolbar=no,width=620,height=400')){location.href=f+'jump=yes'; document.getElementById('diaspora').style.backgroundPosition = '0 -90px';}else{document.getElementById('diaspora').style.backgroundPosition = '0 -60px';}})()"> </div></td>

            </tr></table>
        <!-- Platzieren Sie diese Render-Anweisung an einer geeigneten Stelle. -->
        <script type="text/javascript">
            (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
            })();
        </script>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        <script src="http://static.ak.fbcdn.net/connect.php/js/FB.Share"
                type="text/javascript">
        </script>
        {# owner #}
        {% if request.user == quest.owner %}
            {% include "herobase/quest/adventures.inc.html" %}
        {% endif %}
    </div>
{% endblock %}